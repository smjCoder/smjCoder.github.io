---
title: "什么是协程，是否可以使用 try catch 捕获异常"
date: 2018-09-09T16:37:00+08:00
lastmod: 2018-09-09T16:37:00+08:00
draft: true
tags: ["Unity", "IEnumerator"]
categories: ["Unity"]
author: "CoderTaoX"
---
> 协程。英文名Coroutine。

<!--more-->

> Unity官方解释：
>
> 一个协程的执行可以在任何地方用yield语句来暂停，yield return的值决定了什么时候协程恢复执行。协程在协调在几帧中执行的操作时有极大的用处.协程几乎没有任何性能开销。
>
> StartCoroutine一般都会立即返回，你也以获得返回结果的值。但是这一步会等到协程结束执行才能生效。

```c#
void Start()
{
    Debug.Log("start0");
    StartCoroutine(Cor01());
    Debug.Log("start1");
}

IEnumerator Cor01()
{
    Debug.Log("Cor0");
    yield return null;
    Debug.Log("Cor1");
}

/*
Result：
start0
test0
start1
test1
*/
```

`yield return` 不同于 `return` 

使用 `yield return` 语句可一次返回一个元素。

通过 [foreach](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/foreach-in) 语句或 LINQ 查询来使用迭代器方法。 `foreach` 循环的每次迭代都会调用迭代器方法。 迭代器方法运行到 `yield return` 语句时，会返回一个 `expression`，并保留当前在代码中的位置。 下次调用迭代器函数时，将从该位置重新开始执行。

可以使用 `yield break` 语句来终止迭代。

### 在协程函数内部使用try-catch的问题

> Because you want to keep the Stream open for the duration of the enumeration AND deal with exceptions AND properly close the file handle either way, I don't think you can use a regular enumeration shortcut (the iterator block, yield-return/yield-break).

```c#
public IEnumerable GetFileTexts(string files)
{
    string[] fileNames = files.Split(',');
    foreach (string fName in fileNames)
    {
        try 
        {
            yield return File.ReadAllText(fName);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex.Message);
        }
    }
}
```

在协程中使用 `try-catch` 时会报错

```c#
Cannot yield a value in the body of a try block with a catch clause
```

我们无法在 `try-catch` 中使用 `yield return` ，需要将 `yield return` 放在 `try-catch` 外：

```c#
public IEnumerable GetFileTexts(string files)
{
    string[] fileNames = files.Split(',');
    string text;
    foreach (string fName in fileNames)
    {
        try 
        {
            text = File.ReadAllText(fName);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex.Message);
            continue;
        }
        yield return text;
    }
}
```

不能将 `yield return` 语句置于 try-catch 块中。 可将 `yield return` 语句置于 try-finally 语句的 try 块中。

可将 `yield break` 语句置于 try 块或 catch 块中，但不能将其置于 finally 块中。

如果 `foreach` 主体（在迭代器方法之外）引发异常，则将执行迭代器方法中的 `finally` 块。

### 使用协程WaitForMilliseconds

```c#
public static class Common
{
	/// <summary>
	/// 等待指定的毫秒
	/// </summary>
    public static IEnumerator WaitForMilliseconds(float milliseconds)
    {
        yield return new WaitForSeconds(milliseconds / 1000.0f);
    }
}

// 调用
// yield return Common.WaitForMillis (5000);
```

协程在 `LateUpdate` 后执行，所以最短的执行时间间隔最短也需要一帧的时间，如果你的程序锁定60帧，那么这个时间间隔最低就是17毫秒，所以并不能通过一个协程做到精确到毫秒的延迟计算

### 引用文档

- [How do I return a value from a coroutine?](https://answers.unity.com/questions/24640/how-do-i-return-a-value-from-a-coroutine.html)
- [How to yiled a try/catch block?](https://answers.unity.com/questions/513117/how-to-yiled-a-trycatch-block-1.html?tdsourcetag=s_pcqq_aiomsg)
- [Cannot yield in the body of a try block with a catch clause](https://documentation.devexpress.com/CodeRush/10220/concepts/code-analysis/code-issues/cannot-yield-in-the-body-of-a-try-block-with-a-catch-clause)
- [Why can't yield return appear inside a try block with a catch?](https://stackoverflow.com/questions/346365/why-cant-yield-return-appear-inside-a-try-block-with-a-catch)
- [How do i make a delay in milliseconds?](https://answers.unity.com/questions/832590/how-do-i-make-a-delay-in-milliseconds.html)
- [yield return with try catch, how can i solve it](https://stackoverflow.com/questions/5067188/yield-return-with-try-catch-how-can-i-solve-it)
- [yield（C# 参考）](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/yield)