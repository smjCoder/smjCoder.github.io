---
layout: article
title: 关于Unity3D通过代码控制编译XCode工程
key: 20180622
tags:
- 中文
- SDK集成
toc: true
date: 2018-06-22 13:26:00
---
> 最近在工作中遇到了一些集成SDK的问题，由于整个框架都是自动化的，所以SDK得集成也需要把所需的编译环境和启动代码写在Unity的脚本中。这两天也查找了很多资料，最终完成了集成，在这里记录一下过程和重点。

<!--more-->

#### 主要使用的方法

```c#
public class iOSPostProcessBuild
{
    //该属性是在build完成后，被调用执行的
    [PostProcessBuild]
    public static void OnPostprocessBuild(BuildTarget buildTarget, string pathToBuildProject)
    {
        if (buildTarget != BuildTarget.iOS)
            return;
        //初始化
        string projectPath = pathToBuildProject + "/Unity-iPhone.xcodeproj/project.pbxproj";
        PBXProject pbxProj = new PBXProject();
        pbxProj.ReadFromFile(projectPath);
        string targetGuid = pbxProj.TargetGuidByName("Unity-iPhone");
        .
        .
        .
        //保存所有修改
        pbxProject.WriteToFile(projectPath);
    }
}
```

在`[PostProcessBuild]`下的方法会在build完成之后被调用，在这个方法对XCode工程的编译选项和plist文件进行编辑。

#### 对XCode的编译选项进行操作

需要引入`UnityEditor.iOS.Xcode`命名空间。

```c#


//添加flag
pbxProj.AddBuildProperty(targetGuid, "OTHER_LDFLAGS", "-ObjC");
//关闭BitCode
pbxProj.SetBuildProperty(targetGuid, "ENABLE_BITCODE", "NO");
//添加framwork
pbxProj.AddFrameworkToProject(targetGuid, "CFNetwork.framework", false);
//添加lib
pbxProj.AddFileTobuild(targetGuid, pbxProj.AddFile("usr/lib/libsqlite3.tbd", "Frameworks/libsqlite3.tbd", PBXSourceTree.Sdk));
//应用修改
File.WriteAllText(projectPath, pbxProj.WriteToString());
```

#### 修改Info.plist文件

```c#
string plistPath = Path.Combine(pathToBuildProject, "Info.plist");
PlistDocument plist = new PlistDocument();
plist.ReadFromFile(plistPath);
PlistElementDict rootDict = plist.root;

// NSAppTransportSecurity
const string nsappKey = "NSAppTransportSecurity";
PlistElementDict nsappDic;
PlistElement nspel;
if (rootDict.values.TryGetValue(nsappKey, out nspel))
    nsappDic = nspel.AsDict();
else
    nsappDic = rootDict.CreateDict(nsappKey);
nsappDic.SetBoolean("NSAllowsArbitraryLoads", true);

// 应用修改
File.WriteAllText(plistPath, plist.WriteToString());
```

#### 修改OC代码

```c#

```

#### 添加自定义类库

```c#

```

